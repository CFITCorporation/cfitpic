"use strict";window.console||(window.console={log:function(){},dir:function(){}});var popup_get_cookie=function(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):void 0},popup_set_cookie=function(e,t,i){var o=(i=i||{}).expires;if("number"==typeof o&&o){var n=new Date;n.setTime(n.getTime()+1e3*o),o=i.expires=n}o&&o.toUTCString&&(i.expires=o.toUTCString());var s=e+"="+(t=encodeURIComponent(t));for(var a in i){s+="; "+a;var r=i[a];!0!==r&&(s+="="+r)}document.cookie=s},load_script=function(e,t){var i,o,n;o=!1,(i=document.createElement("script")).type="text/javascript",i.src=e,i.onload=i.onreadystatechange=function(){o||this.readyState&&"complete"!=this.readyState||(o=!0,t())},(n=document.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n)},getSelText=function(){var e="";if(window.getSelection)e=window.getSelection();else if(document.getSelection)e=document.getSelection();else{if(!document.selection)return;e=document.selection.createRange().text}return e.toString()},ajax_request2=function(e,t,i,o){null==o&&(o="POST");var n=new FormData;for(var s in t)n.append(s,t[s]);var a=new XMLHttpRequest;a.open(o,e),a.onreadystatechange=function(){i(a)},a.send(n)},ajax_request3=function(e,t,i,o){null==o&&(o="POST");var n=new XMLHttpRequest;n.open(o,e),n.onreadystatechange=function(){i(n)},n.send(t)},forEach=function(e,t,i){for(var o=0;o<e.length;o++)t.call(i,e[o],o)},get_by_id=function(e){return document.getElementById(e)},getClickPosition=function(e){var t=getElementPosition(e.currentTarget);return{x:e.clientX-t.x,y:e.clientY-t.y}},getElementPosition=function(e){for(var t=0,i=0,o=0,n=0;e;)"BODY"==e.tagName?(o=document.documentElement.scrollLeft>e.scrollLeft?document.documentElement.scrollLeft:e.scrollLeft,n=document.documentElement.scrollTop>e.scrollTop?document.documentElement.scrollTop:e.scrollTop):(o=e.scrollLeft,n=e.scrollTop),t+=e.offsetLeft-o+e.clientLeft,i+=e.offsetTop-n+e.clientTop,e=e.offsetParent;return{x:t,y:i}},queryString=function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]));return t.join("&")},bbcode_tags=function(e){forEach(document.querySelectorAll(".bbcode_tag"),(function(t){t.addEventListener("click",(function(t){var i=document.getElementById(e),o="";if(t.preventDefault(),t.stopPropagation(),""==(o=getSelText())){if(i.focus(),o=getSelText(),"number"==typeof i.selectionStart&&"number"==typeof i.selectionEnd){var n=i.value.slice(i.selectionStart,i.selectionEnd),s=i.value.slice(0,i.selectionStart),a=i.value.slice(i.selectionEnd);i.value=s+this.getAttribute("data-param-open")+n+this.getAttribute("data-param-close")+a}}else i.value+=this.getAttribute("data-param-open")+o+this.getAttribute("data-param-close")}))}))};String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}});var hexToRgb=function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(e,t,i,o){return t+t+i+i+o+o}));var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},AnimePictures={};(function(){this.AutoComplete=function(e,t,i,o){var n=this;if(n.auto_append=null==i||i,n.logic_op=null==o?"||":o,this.input_tag=get_by_id(e),null!=this.input_tag&&null!=this.input_tag){this.input_tag.form&&this.input_tag.form.setAttribute("autocomplete","off"),null!=this.input_tag.setAttribute&&this.input_tag.setAttribute("autocomplete","off"),this.action_url=t,this.focus_block=!1,this.autocomplete_text="",this.key_count=-1,this.focus_t=null,this.focus_t2=null,this.reload_time=200,this.skip_focus=!1;var s=document.body;s.getBoundingClientRect(),this.input_tag.getBoundingClientRect();return this.tags_list=document.createElement("UL"),this.tags_list.setAttribute("class","autocomplite"),this.make_tag_list_position(),s.appendChild(this.tags_list),this.input_tag.addEventListener("focus",(function(){if(n.make_tag_list_position(),n.skip_focus)return n.skip_focus=!1,clearTimeout(n.focus_t),void(n.focus_t=null);n.focus_t=setInterval((function(){n.load()}),1e3)}),!0),this.input_tag.addEventListener("blur",(function(){n.focus_t2||(clearTimeout(n.focus_t),n.focus_t2=setInterval((function(){n.hidden()}),500))})),document.addEventListener("click",(function(e){n.tags_list!=e.target&&n.hidden()})),this.input_tag.addEventListener("keydown",(function(e){n.keyh(e)}),!0),window.addEventListener("resize",(function(e){n.make_tag_list_position()})),this}},this.AutoComplete.prototype.make_tag_list_position=function(){var e=document.body.getBoundingClientRect(),t=this.input_tag.getBoundingClientRect();this.tags_list.style.width=this.input_tag.offsetWidth+"px",this.tags_list.style.left=t.left-e.left+"px",this.tags_list.style.top=t.top-e.top+this.input_tag.offsetHeight+"px"},this.AutoComplete.prototype.hidden=function(){this.tags_list.style.visibility="hidden",clearTimeout(this.focus_t2)},this.AutoComplete.prototype.ajax_load=function(e){var t=this;""!=e&&e.length>0&&ajax_request2(this.action_url,{tag:e},(function(e){if(4==e.readyState)if(200==e.status){var i=JSON.parse(e.responseText).tags_list;if(null!=i){var o,n,s;t.tags_list.innerHTML="";for(var a=0;a<i.length;a++){switch(o=document.createElement("LI"),i[a].t2?(o.text=i[a].t2,o.innerHTML=i[a].t+" â†’ "+i[a].t2):(o.text=i[a].t,o.innerHTML=i[a].t),t.tags_list.appendChild(o),i[a].c){case 1:o.innerHTML=o.innerHTML,o.style.color="#006699";break;case 3:case 5:case 6:o.style.color="green";break;case 4:o.style.color="darkorange",o.style.fontStyle="italic"}o.addEventListener("click",(function(){t.skip_focus=!0,t.set_text(this,!0),t.input_tag.focus()}))}1==t.auto_append&&1==i.length&&(n=t.input_tag.value.lastIndexOf("||"),(s=t.input_tag.value.lastIndexOf("&&"))>n&&(n=s),(n>0?t.input_tag.value.substring(n+2):t.input_tag.value)==(i[0].t2?i[0].t2:i[0].t).replace("<b>","").replace("</b>","")&&(t.input_tag.value=t.input_tag.value+"||"))}else t.hidden()}else console.log("Network error")}))},this.AutoComplete.prototype.load=function(){if(!this.focus_block&&this.input_tag.value!=this.autocomplete_text){if(this.input_tag.value.length>0){var e=this.input_tag.value.lastIndexOf("||"),t=this.input_tag.value.lastIndexOf("&&");t>e&&(e=t),e>0?this.ajax_load(this.input_tag.value.substring(e+2)):this.ajax_load(this.input_tag.value),this.key_count=-1,this.tags_list.style.visibility="visible"}else this.tags_list.innerHTML="";this.autocomplete_text=this.input_tag.value}},this.AutoComplete.prototype.set_text=function(e,t){if(null!=e){var i=this.input_tag.value.lastIndexOf("||"),o=this.input_tag.value.lastIndexOf("&&");o>i&&(i=o),i>0?this.input_tag.value=this.input_tag.value.substring(0,i+2)+e.text.replace("<b>","").replace("</b>",""):e&&(this.input_tag.value=e.text.replace("<b>","").replace("</b>","")),1==this.auto_append&&null!=t&&(this.input_tag.value=this.input_tag.value+this.logic_op)}},this.AutoComplete.prototype.keyh=function(e){var t=this,i=e.which||e.keyCode,o=this.key_count,n=0,s=this.tags_list.querySelectorAll("li");return 40==i&&this.key_count<s.length-1&&(this.key_count+=1,n=1),38==i&&this.key_count>0&&(this.key_count-=1,n=1),13==i&&this.key_count&&(t.set_text(s[this.key_count]),n=1),39==i&&this.key_count?(t.set_text(s[this.key_count],!0),this.key_count=-1,void t.hidden()):27==i?(this.key_count=-1,void t.hidden()):void(1==n&&this.key_count>=0?(this.focus_block=1,s[this.key_count].classList.add("autocomplite_active"),o>=0&&s[o].classList.remove("autocomplite_active"),t.set_text(s[this.key_count])):(this.focus_block=0,null==this.focus_t&&(this.focus_t=setInterval((function(){t.load()}),this.reload_time))))}}).apply(AnimePictures),function(){var e=this;this.last_url=document.location.href,this.post={voting:function(e,t){null==t&&(t=post_id);ajax_request2("/pictures/vote",{post:t,vote:e},(function(t){if(4==t.readyState)if(200==t.status){var i=JSON.parse(t.responseText),o=get_by_id("rating_star_it"),n=o.getAttribute("title");o.setAttribute("title",o.getAttribute("data-back-title")),o.setAttribute("data-back-title",n),9==e?(star_it=!0,o.classList.remove("star_it"),o.classList.add("unstar_it")):(star_it=!1,o.classList.remove("unstar_it"),o.classList.add("star_it")),get_by_id("score_n").innerHTML=i.score_n}else console.log("Network error")}))},set_favorites:function(){var t=get_by_id("favorite_folder_select"),i=get_by_id("favorite_status");ajax_request2("/pictures/set_favorites/"+post_id,{favorite_folder:t.value},(function(o){4==o.readyState&&(200==o.status?JSON.parse(o.responseText).success?(i.innerHTML=ts.Ok,"Null"!=t.value&&post_juser_id!=window.db_user_id&&0==star_it&&e.post.voting(9)):(i.innerHTML=ts.Error,console.log("Can`t set favorite.")):console.log("Network error"))}))},add_tag:function(t){var i=get_by_id("add_tag_input"),o=get_by_id("add_tag_status"),n=get_by_id("post_tags");if(t=void 0!==t?t:"false",""!=i.value){return ajax_request2("/pictures/add_tag_to_post/"+post_id,{text:i.value,add_new_tag:t},(function(t){if(4==t.readyState)if(200==t.status){var s=JSON.parse(t.responseText);s.success?(o.innerHTML=ts.Ok,n.innerHTML=s.post_tags,i.value="",get_by_id("recommend_tags").innerHTML=""):(o.innerHTML=s.errormsg,null!=s.post_tags&&(n.innerHTML=s.post_tags),s.error_new_tag&&confirm(ts["WARNING Add new tag"]+s.errormsg)&&e.post.add_tag("true"),s.error_new_tag_user&&alert(ts["ERROR Add new tag"]+s.errormsg))}else console.log("Network error")})),!1}},delete_tag:function(e){var t=get_by_id("post_tags");return ajax_request2("/pictures/del_tag_from_post/"+post_id,{tag_id:e},(function(e){if(4==e.readyState)if(200==e.status){var i=JSON.parse(e.responseText);i.success?t.innerHTML=i.post_tags:console.log("Error")}else console.log("Network error")})),!1},refresh_tags:function(){var e=get_by_id("post_tags");return ajax_request2("/pictures/refresh_post_tags/"+post_id,null,(function(t){4==t.readyState&&(200==t.status?e.innerHTML=t.responseText:console.log("Network error"))})),!1},add_pre_tag:function(){var e=get_by_id("add_pre_tag_input"),t=get_by_id("add_pre_tag_status");if(""!=e.value){return ajax_request2("/pictures/add_pre_tag_to_post/"+post_id,{text:e.value},(function(i){if(4==i.readyState)if(200==i.status){var o=JSON.parse(i.responseText);if(o.success){t.innerHTML=ts.Ok;var n=o.error_tags;n.length>0&&(t.innerHTML+=" "+ts["but we have problems with next tags:"]+"<br>");for(var s=0;s<n.length;s+=1)t.innerHTML+="<b>"+n[s].text+"</b>",1===n[s].type?t.innerHTML+=" - "+ts["unknown tag"]+"<br>":2===n[s].type?t.innerHTML+=" - "+ts["have already in recommendation"]+"<br>":3===n[s].type&&(t.innerHTML+=" - "+ts["have already on picture"]+"<br>");e.value=""}}else console.log("Network error")})),!1}},get_recommendation_tags:function(){ajax_request2("/pictures/tag_recommendation_for_post/"+post_id,{},(function(e){4==e.readyState&&(200==e.status?get_by_id("recommend_tags").innerHTML=e.responseText:console.log("Network error"))}))},show_curent_rect_timeout:null,show_curent_rect:function(t){e.post.tag_area&&forEach(get_by_id("post_tags").querySelectorAll("a"),(function(i){var o=i.getAttribute("data-rect");null!=o&&(o=JSON.parse(o),t.x>o[0].x&&t.y>o[0].y&&t.x<o[1].x&&t.y<o[1].y)&&e.post.tag_area.ex_show_area(o[0],o[1],i.innerHTML,!0)}))},init_post:function(t){var i=this;if(is_login){db_user_id!=post_juser_id&&get_by_id("rating_star_it").addEventListener("click",(function(e){this.classList.contains("star_it")?i.voting(9):i.voting(0)}));var o=get_by_id("favorite_folder_select");null!=o&&o.addEventListener("change",i.set_favorites),get_by_id("add_tag_input")&&(i.autocomplete_add_tag=new AnimePictures.AutoComplete("add_tag_input","/pictures/autocomplete_tag",!0),get_by_id("add_tag_submit").addEventListener("click",i.add_tag),get_by_id("add_tag_form").addEventListener("submit",i.add_tag),get_by_id("get_recommendation_tags").addEventListener("click",i.get_recommendation_tags)),get_by_id("add_pre_tag_input")&&(i.autocomplete_add_tag=new AnimePictures.AutoComplete("add_pre_tag_input","/pictures/autocomplete_tag"),get_by_id("add_pre_tag_submit").addEventListener("click",i.add_pre_tag),get_by_id("add_pre_tag_form").addEventListener("submit",i.add_pre_tag)),window.addEventListener("message",(function(e){"https://anime-pictures.net"===e.origin&&"update_tags"===e.data.cmd&&i.refresh_tags()}),!1)}t||window.addEventListener("popstate",(function(t){e.last_url!=document.location.href&&(document.location=document.location)})),i.tag_area=new e.TagArea,get_by_id("big_preview").addEventListener("mousemove",(function(e){if(void 0===i.tag_area.edit_area_click1){i.show_curent_rect_timeout&&(clearTimeout(i.show_curent_rect_timeout),i.show_curent_rect_timeout=null);var t=getClickPosition(e);i.show_curent_rect_timeout=setTimeout((function(){i.show_curent_rect(t)}),300)}})),get_by_id("post_tags").addEventListener("mouseover",(function(e){if("A"==e.target.tagName){var t=e.target.getAttribute("data-rect");null!=t&&(t=JSON.parse(t),i.tag_area.ex_show_area(t[0],t[1],e.target.textContent))}})),get_by_id("post_tags").addEventListener("mouseout",(function(e){"A"==e.target.tagName&&i.tag_area.ex_hide()})),get_by_id("post_tags").addEventListener("click",(function(e){var t=function(e){return get_by_id("tag_li_"+o).querySelector("a").textContent};if("icon_delete"==e.target.getAttribute("class")){var o=e.target.parentNode.getAttribute("data-tag-id");confirm(ts["Remove the tag?"]+" "+t())&&i.delete_tag(o)}if("icon_frame"==e.target.getAttribute("class")){o=e.target.parentNode.getAttribute("data-tag-id");i.tag_area.edit_area((function(){i.tag_area.send_tag_rect(o)}))}if("icon_edit"==e.target.getAttribute("class")){o=e.target.parentNode.getAttribute("data-tag-id");window.open("/pictures/view_edit_tag/"+o,ts["Edit tag"]+" "+t(),"width=500,height=700")}}))}}}.apply(AnimePictures),function(){this.TagArea=function(){return this.big_preview_cont=get_by_id("big_preview_cont"),this.big_preview=get_by_id("big_preview"),this.fade_div=null,this.real_cont=this.big_preview_cont,this.cont_position=this.real_cont.getBoundingClientRect(),this.cont_dem=this.real_cont.getBoundingClientRect(),this.img_pos=this.big_preview.getBoundingClientRect(),this.last_top_area=0,this.last_left_area=0,this},this.TagArea.prototype.init_area=function(){if(!this.fade_div){var e=getElementPosition(this.big_preview_cont);this.img_pos=getElementPosition(this.big_preview),this.img_dem=this.big_preview.getBoundingClientRect(),this.fade_div=document.createElement("div"),this.fade_div.id="fade_div",this.fade_div.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.fade_div.style.position="absolute",this.fade_div.style.zIndex="100",this.fade_div.style.left=this.img_pos.x-e.x+"px",this.fade_div.style.top=this.img_pos.y-e.y+"px",this.fade_div.style.width=this.img_dem.width+"px",this.fade_div.style.height=this.img_dem.height+"px",this.big_preview_cont.appendChild(this.fade_div)}},this.TagArea.prototype.reorder_square=function(e,t){var i,o,n,s;return e.x>t.x?(i=t.x,n=e.x-t.x):(i=e.x,n=t.x-e.x),e.y>t.y?(o=t.y,s=e.y-t.y):(o=e.y,s=t.y-e.y),{left:i,top:o,width:n,height:s}},this.TagArea.prototype.ex_show_area=function(e,t,i,o){null==this.fade_div_onclick&&this.show_area(e,t,i,o)},this.TagArea.prototype.show_area=function(e,t,i,o){var n=this;null==n.over_fade_div&&(this.init_area(),n.over_fade_div=document.createElement("div"),n.over_fade_div.id="over_fade_div",n.fade_div.appendChild(n.over_fade_div)),null!=i&&null==n.over_fade_span&&(n.over_fade_span=document.createElement("span"),n.over_fade_span.id="over_fade_span",n.fade_div.appendChild(n.over_fade_span));var s=this.reorder_square(e,t);if(n.over_fade_div.style.backgroundImage="url("+n.big_preview.src+")",n.over_fade_div.style.left=s.left+"px",n.over_fade_div.style.top=s.top+"px",n.over_fade_div.style.width=s.width+"px",n.over_fade_div.style.height=s.height+"px",n.over_fade_div.style.backgroundPosition=-s.left-2+"px "+(-s.top-2)+"px",null!=i){n.over_fade_span.innerHTML=i;var a=s.top<50?s.top+s.height+2:s.top-25;n.over_fade_span.style.left=s.left+"px",n.over_fade_span.style.top=a+"px"}return null!=o&&(n.over_fade_div_onmouseout=function(){n.hide()},n.over_fade_div.addEventListener("mouseout",n.over_fade_div_onmouseout)),n.over_fade_div},this.TagArea.prototype.resize_area=function(e,t){var i=this.reorder_square(e,t);i.width<25||i.height<25||(this.over_fade_div.style.width=i.width+"px",this.over_fade_div.style.height=i.height+"px",self.last_top_area==i.top&&self.last_left_area==i.left||(this.over_fade_div.style.left=i.left+"px",this.over_fade_div.style.top=i.top+"px",this.over_fade_div.style.backgroundPosition=-i.left-2+"px "+(-i.top-2)+"px"),self.last_top_area=i.top,self.last_left_area=i.left)},this.TagArea.prototype.ex_hide=function(){null==this.fade_div_onclick&&this.hide()},this.TagArea.prototype.hide=function(){this.fade_div&&(this.remove_control(),null!=this.fade_div_onclick&&(this.fade_div.removeEventListener("click",this.fade_div_onclick),delete this.fade_div_onclick),null!=this.fade_div_onmousemove&&(this.fade_div.removeEventListener("mousemove",this.fade_div_onclick),delete this.fade_div_onmousemove),null!=this.over_fade_div_onmouseout&&(this.over_fade_div.removeEventListener("mouseout",this.over_fade_div_onmouseout),delete this.over_fade_div_onmouseout),this.fade_div.parentElement.removeChild(this.fade_div),delete this.fade_div,null!=this.over_fade_div&&delete this.over_fade_div,null!=this.over_fade_span&&delete this.over_fade_span,this.fade_div=null,delete this.done_function)},this.TagArea.prototype.edit_area=function(e){var t=this;(t.fade_div||null!=t.edit_area_click1)&&(t.hide(),void 0!==t.edit_area_click1&&delete t.edit_area_click1),t.done_function=e,t.show_area({x:100,y:100},{x:200,y:200}),t.selection_area={s_p1:{x:100,y:100},s_p2:{x:200,y:200}},t.fade_div.style.cursor="pointer",t.show_control(),t.fade_div_onclick=function(e){var i=getClickPosition(e);null==t.edit_area_click1?(t.hide_control(),t.edit_area_click1=i,t.resize_area(t.edit_area_click1,{x:t.edit_area_click1.x+25,y:t.edit_area_click1.y+25})):(t.selection_area={s_p1:t.edit_area_click1,s_p2:i},delete t.edit_area_click1,t.resize_area(t.selection_area.s_p1,t.selection_area.s_p2),t.show_control())},t.fade_div.addEventListener("click",t.fade_div_onclick),t.fade_div_onmousemove=function(e){var i=getClickPosition(e);void 0!==t.edit_area_click1&&t.resize_area(t.edit_area_click1,i)},t.fade_div.addEventListener("mousemove",t.fade_div_onmousemove)},this.TagArea.prototype.show_control=function(){var e=this;if(void 0!==e.selection_area||void 0===e.control_div){e.control_div=document.createElement("div"),e.control_div.id="control_div",e.fade_div.appendChild(e.control_div);var t=this.reorder_square(e.selection_area.s_p1,e.selection_area.s_p2);e.control_div.style.left=t.left+t.width+5+"px",e.control_div.style.top=t.top+(t.height-64)+"px",e.control_cancel=document.createElement("span"),e.control_cancel.title=ts.Cancel,e.control_cancel.className="icon_close",e.control_cancel.style.cursor="pointer",e.control_done=document.createElement("span"),e.control_done.title=ts.Done,e.control_done.className="icon_apply",e.control_done.style.cursor="pointer",e.control_trash=document.createElement("span"),e.control_trash.title=ts["Remove area"],e.control_trash.className="icon_area_trash",e.control_trash.style.cursor="pointer",e.control_div.appendChild(e.control_cancel),e.control_div.appendChild(e.control_done),e.control_div.appendChild(e.control_trash),e.control_cancel_onclick=function(){e.hide()},e.control_cancel.addEventListener("click",e.control_cancel_onclick),e.control_done_onclick=function(){e.remove_control(),e.fade_div.removeEventListener("click",e.fade_div_onclick),e.fade_div_onclick=null,e.done_function()},e.control_done.addEventListener("click",e.control_done_onclick),e.control_trash_onclick=function(){e.remove_control(),e.fade_div.removeEventListener("click",e.fade_div_onclick),e.fade_div_onclick=null,e.selection_area={s_p1:{x:0,y:0},s_p2:{x:0,y:0}},e.done_function()},e.control_trash.addEventListener("click",e.control_trash_onclick)}if(void 0!==e.selection_area||void 0!==e.control_div){t=this.reorder_square(e.selection_area.s_p1,e.selection_area.s_p2);e.control_div.style.left=t.left+t.width+5+"px",e.control_div.style.top=t.top+(t.height-102+4)+"px",e.control_div.style.visibility="visible"}},this.TagArea.prototype.hide_control=function(){void 0!==this.control_div&&(this.control_div.style.visibility="hidden")},this.TagArea.prototype.remove_control=function(){null!=this.control_div&&(null!=this.control_cancel_onclick&&(this.control_cancel.removeEventListener("click",this.control_cancel_onclick),delete this.control_div_onclick),null!=this.control_done_onclick&&(this.control_done.removeEventListener("click",this.control_done_onclick),delete this.control_done_onclick),null!=this.control_trash_onclick&&(this.control_trash.removeEventListener("click",this.control_trash_onclick),delete this.control_trash_onclick),this.control_div.parentElement.removeChild(this.control_div),delete this.control_div)},this.TagArea.prototype.send_tag_rect=function(e){var t=this,i=this.reorder_square(t.selection_area.s_p1,t.selection_area.s_p2),o={tag_id:e,post_id:post_id,s_x1:parseInt(i.left),s_y1:parseInt(i.top),s_x2:parseInt(i.left+i.width),s_y2:parseInt(i.top+i.height)};ajax_request2("/pictures/set_tag_rect",o,(function(e){if(t.hide(),4==e.readyState)if(200==e.status){var i=JSON.parse(e.responseText);i.success?post_tags.innerHTML=i.post_tags:console.log("Error")}else console.log("Network error")}))}}.apply(AnimePictures),function(){var e=this,t=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)};this.post_list={refresh:function(t,i,o){if(null!=e.autocomplete_search_tag&&e.autocomplete_search_tag.hidden(),!history.pushState)return!0;o=void 0===o||o;var n,s,a,r,l={ajax:1};if(i)for(var _=0;_<i.elements.length;_++)i.elements[_].name&&("radio"==i.elements[_].type||"checkbox"==i.elements[_].type?i.elements[_].checked&&(l[i.elements[_].name]=i.elements[_].value):""!=i.elements[_].value&&"submit"!=i.elements[_].type&&(l[i.elements[_].name]=i.elements[_].value));else n=document.querySelector(".posts_block > span:last-child"),r=window.location.pathname.split("/"),s=parseInt(r[r.length-1]),null==t.pathname?(r=t.split("/"),a=parseInt(r[r.length-1].match(/(\d*)\?/i)[1])):(r=t.pathname.split("/"),a=parseInt(r[r.length-1])),a>s&&(l.last_page=s,l.last_post_date=n.getAttribute("data-pubtime"),console.log(s,a));return l.lang=lang,null!=l.search_tag&&""!=l.search_tag?document.title=l.search_tag+" "+ts.posts_title:document.title=ts.posts_title,ajax_request2(i?t+"/":t,l,(function(n){if(4==n.readyState){if(200!=n.status)return console.log("Network error"),void(get_by_id("page_load_progress").innerHTML="Network error");if(get_by_id("posts").innerHTML=n.responseText,get_by_id("page_load_progress").style.visibility="hidden",o)if(i){var s=parseInt(l.page,10);delete l.ajax,delete l.page,delete l.hex_color,history.pushState({},"",t.replace("view_posts","view_posts")+"/"+s+"?"+queryString(l))}else history.pushState({},"",t.replace("view_posts","view_posts"));get_by_id("page_load_progress").innerHTML="",e.init_subscribe_tag(),window.scroll(0,0),e.last_url=document.location.href}})),get_by_id("page_load_progress").style.visibility="visible",!1},init:function(i){i||window.addEventListener("popstate",(function(t){if(e.last_url!=document.location.href&&(console.log(document.location.href,e.last_url),document.location.href.search("view_posts")>=0))return e.last_url.search("view_posts")>=0?e.post_list.refresh(document.location,!1,!1):e.last_url=document.location.href,!0})),get_by_id("aspect").addEventListener("click",(function(){if(""!=get_by_id("res_x_id").value&&""!=get_by_id("res_y_id").value){var e=get_by_id("res_x_id").value,i=get_by_id("res_y_id").value;this.value=t(e/i,2)}})),get_by_id("myColor").addEventListener("change",(function(){var e=hexToRgb(this.value);get_by_id("rgb_color").value=e.r+"_"+e.g+"_"+e.b+"_150"})),get_by_id("clear_color").addEventListener("click",(function(){var e=get_by_id("myColor");get_by_id("rgb_color").value="",e.value="#000000"})),e.autocomplete_search_tag=new AnimePictures.AutoComplete("search_tag_input","/pictures/autocomplete_tag",!1),e.autocomplete_denied_tag=new AnimePictures.AutoComplete("denied_tag_input","/pictures/autocomplete_tag"),is_moderator&&(e.autocomplete_multi_tags=new AnimePictures.AutoComplete("multi_tags","/pictures/autocomplete_tag")),get_by_id("auto_resolution").addEventListener("click",(function(){get_by_id("res_x_id").value=screen.width,get_by_id("res_y_id").value=screen.height,get_by_id("aspect").value=t(screen.width/screen.height,2),get_by_id("res_x_1_id").checked="checked",get_by_id("res_y_1_id").checked="checked"}));var o=function(){e.active_tag_input=this};get_by_id("search_tag_input").addEventListener("blur",o),get_by_id("denied_tag_input").addEventListener("blur",o),get_by_id("push_or").addEventListener("click",(function(){var t=e.active_tag_input;null==t&&(t=get_by_id("search_tag_input")),t.value+="||",t.focus()})),get_by_id("push_and").addEventListener("click",(function(){get_by_id("search_tag_input").value+="&&",get_by_id("search_tag_input").focus()})),get_by_id("optional_form_trigger").addEventListener("click",(function(e){e.preventDefault(),get_by_id("optional_form").classList.add("optional_form_active")})),get_by_id("search_form").addEventListener("submit",(function(t){t.preventDefault(),e.post_list.refresh("/pictures/view_posts",this)}));var n=get_by_id("multi_check_all");is_moderator&&null!=n&&(n.addEventListener("click",(function(){forEach(get_by_id("posts").querySelectorAll("input"),(function(e){e.checked?e.checked=!1:e.checked=!0}))})),get_by_id("multi_add_tags").addEventListener("click",(function(){var e,t;t={action:e="add_tags"},"add_tags"==e&&(t.text=get_by_id("multi_tags").value),forEach(get_by_id("posts").querySelectorAll("input"),(function(e){e.checked&&(t[e.name]=e.value)})),ajax_request2("/pictures/multi_action",t,(function(e){4==e.readyState&&(200==e.status?window.location.href=window.location.href:console.log("Network error"))})),get_by_id("multi_add_tags").disabled=!0,get_by_id("multi_check_all").disabled=!0})))}}}.apply(AnimePictures),function(){this.login=function(){var e={login:get_by_id("form_login_login").value,password:get_by_id("form_login_password").value,time_zone:time_zone};ajax_request2(this.action,e,(function(e){if(4==e.readyState){if(200!=e.status)return console.log("Network error"),void(get_by_id("form_login_error").innerHTML="Network error");var t=JSON.parse(e.responseText);t.success?window.location.toString().search("login")>=0?window.location="/":window.location.reload():get_by_id("form_login_error").innerHTML=t.errormsg}}))}}.apply(AnimePictures),null==window.is_login||is_login||document.addEventListener("DOMContentLoaded",(function(){var e=get_by_id("form_login");null!=e&&e.addEventListener("submit",AnimePictures.login)})),AnimePictures.gen_preview_url=function(e,t){return".gif"==e.ext?images_preview_host+"/"+e.md5.substr(0,3)+"/"+e.md5+"_"+t+".gif":e.have_alpha?images_preview_host+"/"+e.md5.substr(0,3)+"/"+e.md5+"_"+t+".png":images_preview_host+"/"+e.md5.substr(0,3)+"/"+e.md5+"_"+t+".jpg"},AnimePictures.realtime_stars=function(){var e=get_by_id("sidebar_last_scores_body");if(null!=e){var t=0;null!=window.post_erotic_level&&(t=window.post_erotic_level);var i=-1;null!=window.post_id&&(i=window.post_id);var o="wss://";"localhost"==window.location.hostname&&(o="ws://"),AnimePictures.realtime_stars_ws=new WebSocket(o+window.location.hostname+"/realtime_stars?erotic_level="+t+"&post_id="+i);var n=function(t){if("close"!=t.type){var i=!1,o=function(e,t,i){var o=document.createElement("span");o.setAttribute("id","post_user_"+t.id),i||o.appendChild(document.createTextNode(", "));var n=document.createElement("a");n.appendChild(document.createTextNode(t.name)),n.setAttribute("href","/profile/view_ext_profile/"+t.id+"?lang="+lang),n.className="user_link",t.groups.indexOf("commiter")>=0&&(n.style.color="#0000cc"),t.groups.indexOf("moderator")>=0&&(n.style.color="#00aa00"),t.groups.indexOf("admin")>=0&&(n.style.color="#ff0000"),o.appendChild(n),e.appendChild(o)},n=JSON.parse(t.data);if("new_star"==n.type){var s=document.createElement("a");s.className="last_scores_image",s.style.maxHeight="0",s.style.boxShadow="0 0 20px 2px rgb("+n.color_r+", "+n.color_g+", "+n.color_b+")",s.setAttribute("href","/pictures/view_post/"+n.post+"?lang="+lang);var a=document.createElement("div");a.style.backgroundColor="rgb("+n.color_r+", "+n.color_g+", "+n.color_b+")",a.style.backgroundImage="url('"+AnimePictures.gen_preview_url(n,"cp")+"')",!0===n.spoiler&&null!=a.style.filter&&(a.style.filter="blur(12px)"),s.appendChild(a),e.insertBefore(s,e.firstChild),e.removeChild(e.lastChild),null!=n.mp_users&&(get_by_id("mp_users").innerHTML=n.mp_users),setTimeout((function(){s.style.maxHeight="200px"}),100)}else if("new_post_user"==n.type){null!=(l=document.getElementById("post_now_watching"))&&(0==l.children.length&&(i=!0),o(l,n,i),i&&(l.style.maxHeight="600px",l.style.padding="10px"))}else if("del_post_user"==n.type){if(null!=(l=document.getElementById("post_now_watching"))){var r=document.getElementById("post_user_"+n.id);null!=r&&l.removeChild(r),0==l.children.length&&(l.style.maxHeight="0",l.style.padding="0")}}else if(n.type="all_post_users"){var l;if(null!=(l=document.getElementById("post_now_watching"))&&Object.keys(n.users).length>0){0==l.children.length&&(i=!0);var _=i;for(var c in n.users)o(l,n.users[c],_),_=!1;i&&(l.style.maxHeight="600px",l.style.padding="10px")}}}else console.log("close event")};AnimePictures.realtime_stars_ws.onopen=function(){console.log("Open socket")},AnimePictures.realtime_stars_ws.onmessage=n,AnimePictures.realtime_stars_ws.onclose=n}},document.addEventListener("DOMContentLoaded",(function(){const e=get_by_id("mobile_menu_icon"),t=get_by_id("mobile_menu"),i=document.getElementsByTagName("header")[0];null!=e&&(e.addEventListener("click",(function(o){o.preventDefault(),o.stopPropagation();const n=i.offsetHeight-window.scrollY;t.style.top=(n<0?0:n)+"px",t.classList.toggle("activate"),e.classList.toggle("is-active")})),document.body.addEventListener("click",(function(i){e.classList.contains("is-active")&&(t.classList.toggle("activate"),e.classList.toggle("is-active"))})),t.addEventListener("click",(function(e){e.stopPropagation()})),window.addEventListener("scroll",(function(o){if(e.classList.contains("is-active")){const e=i.offsetHeight-window.scrollY;t.style.top=(e<0?0:e)+"px"}}))),AnimePictures.realtime_stars()})),function(){this.subscribe_tag=function(e){e.preventDefault();var t=get_by_id("posts_body_head_subaction"),i=t.getAttribute("data-action"),o=t.getAttribute("data-id"),n=t.getAttribute("data-name"),s=function(e){if(4==e.readyState){if(200!=e.status)return console.log("Network error"),void alert("Network error");var o=JSON.parse(e.responseText);o.success?"subscribe"==i?(t.setAttribute("data-action","unsubscribe"),t.textContent=ts.unsubscribe):(t.setAttribute("data-action","subscribe"),t.textContent=ts.subscribe):alert(o.errormsg)}};"subscribe"==i?ajax_request2("/profile/add_tag_subscribe",{name:n},s,"POST"):ajax_request2("/profile/del_tag_subscribe/"+o,{},s,"GET")},this.init_subscribe_tag=function(){var e=get_by_id("posts_body_head_subaction");null!=e&&e.addEventListener("click",this.subscribe_tag)}}.apply(AnimePictures);var isPushEnabled=!1;Notification.requestPermission().then((function(e){if(window.is_login){if("denied"===e)return console.log("Permission wasn't granted. Allow a retry."),void("true"==localStorage.getItem("is_push_enabled_v2")&&localStorage.setItem("is_push_enabled_v2","false"));if("default"===e)return console.log("The permission request was dismissed."),void("true"==localStorage.getItem("is_push_enabled_v2")&&localStorage.setItem("is_push_enabled_v2","false"));window.addEventListener("load",(function(){if("serviceWorker"in navigator&&"undefined"!=typeof Storage){console.log("Service Worker is supported");var e=window.location.protocol+"//"+window.location.hostname+"/static/js";navigator.serviceWorker.register(e+"/service-worker.js?v=29").then((function(e){if("true"!=localStorage.getItem("is_push_enabled_v2")||"false"==localStorage.getItem("is_push_enabled_withuser")&&null!=window.is_login&&is_login)return e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t("BNazcMuFT7yL_3btN5KeRfIGhzxMYKOUhLMlIMHFePfOqgBL1rx-kVY38XN1yEd_MzKNnUi9c4q6bDDDOWtH8pg")}).then((function(t){var i=JSON.parse(JSON.stringify(t));ajax_request2("/login/register_web_token",{endpoint:i.endpoint,auth:i.keys.auth,p256dh:i.keys.p256dh},(function(e){4==e.readyState&&(200==e.status?JSON.parse(e.responseText).success?(localStorage.setItem("is_push_enabled_v2","true"),null!=window.is_login&&is_login?localStorage.setItem("is_push_enabled_withuser","true"):localStorage.setItem("is_push_enabled_withuser","false")):console.log("Server error"):console.log("Network error"))})),e.active.postMessage({type:"lang",lang:lang})})).catch((function(t){console.log(":^(",t),"InvalidStateError"==t.name&&e.pushManager.getSubscription().then((function(e){e.unsubscribe().then((function(e){console.log("unsubscribe key fine, you will subscribe again in next time")})).catch((function(e){console.log(":^(",e)}))}))}));console.log("web push is enabled"),e.active.postMessage({type:"lang",lang:lang})})).catch((function(e){console.log(":^(",e)}))}}))}function t(e){var t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),i=atob(t),o=new Uint8Array(i.length);for(let e=0;e<i.length;++e)o[e]=i.charCodeAt(e);return o}}));